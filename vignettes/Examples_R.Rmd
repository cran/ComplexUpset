---
title: "Examples - R"
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Examples - R}
  %\usepackage[utf8]{inputenc}
---
```R
library(ggplot2)
library(ComplexUpset)
```

## Prepare the datasets


```R
movies = as.data.frame(ggplot2movies::movies)
head(movies, 3)
```


<table>
<caption>A data.frame: 3 × 24</caption>
<thead>
	<tr><th></th><th scope=col>title</th><th scope=col>year</th><th scope=col>length</th><th scope=col>budget</th><th scope=col>rating</th><th scope=col>votes</th><th scope=col>r1</th><th scope=col>r2</th><th scope=col>r3</th><th scope=col>r4</th><th scope=col>⋯</th><th scope=col>r9</th><th scope=col>r10</th><th scope=col>mpaa</th><th scope=col>Action</th><th scope=col>Animation</th><th scope=col>Comedy</th><th scope=col>Drama</th><th scope=col>Documentary</th><th scope=col>Romance</th><th scope=col>Short</th></tr>
	<tr><th></th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>⋯</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th></tr>
</thead>
<tbody>
	<tr><th scope=row>1</th><td>$                     </td><td>1971</td><td>121</td><td>NA</td><td>6.4</td><td>348</td><td>4.5</td><td> 4.5</td><td>4.5</td><td> 4.5</td><td>⋯</td><td> 4.5</td><td> 4.5</td><td></td><td>0</td><td>0</td><td>1</td><td>1</td><td>0</td><td>0</td><td>0</td></tr>
	<tr><th scope=row>2</th><td>$1000 a Touchdown     </td><td>1939</td><td> 71</td><td>NA</td><td>6.0</td><td> 20</td><td>0.0</td><td>14.5</td><td>4.5</td><td>24.5</td><td>⋯</td><td> 4.5</td><td>14.5</td><td></td><td>0</td><td>0</td><td>1</td><td>0</td><td>0</td><td>0</td><td>0</td></tr>
	<tr><th scope=row>3</th><td>$21 a Day Once a Month</td><td>1941</td><td>  7</td><td>NA</td><td>8.2</td><td>  5</td><td>0.0</td><td> 0.0</td><td>0.0</td><td> 0.0</td><td>⋯</td><td>24.5</td><td>24.5</td><td></td><td>0</td><td>1</td><td>0</td><td>0</td><td>0</td><td>0</td><td>1</td></tr>
</tbody>
</table>




```R
genres = colnames(movies)[18:24]
genres
```


<style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>'Action'</li><li>'Animation'</li><li>'Comedy'</li><li>'Drama'</li><li>'Documentary'</li><li>'Romance'</li><li>'Short'</li></ol>



Convert the genre indicator columns to use boolean values:


```R
movies[genres] = movies[genres] == 1
t(head(movies[genres], 3))
```


<table>
<caption>A matrix: 7 × 3 of type lgl</caption>
<thead>
	<tr><th></th><th scope=col>1</th><th scope=col>2</th><th scope=col>3</th></tr>
</thead>
<tbody>
	<tr><th scope=row>Action</th><td>FALSE</td><td>FALSE</td><td>FALSE</td></tr>
	<tr><th scope=row>Animation</th><td>FALSE</td><td>FALSE</td><td> TRUE</td></tr>
	<tr><th scope=row>Comedy</th><td> TRUE</td><td> TRUE</td><td>FALSE</td></tr>
	<tr><th scope=row>Drama</th><td> TRUE</td><td>FALSE</td><td>FALSE</td></tr>
	<tr><th scope=row>Documentary</th><td>FALSE</td><td>FALSE</td><td>FALSE</td></tr>
	<tr><th scope=row>Romance</th><td>FALSE</td><td>FALSE</td><td>FALSE</td></tr>
	<tr><th scope=row>Short</th><td>FALSE</td><td>FALSE</td><td> TRUE</td></tr>
</tbody>
</table>



To keep the examples fast to compile we will operate on a subset of the movies with complete data:


```R
movies[movies$mpaa == '', 'mpaa'] = NA
movies = na.omit(movies)
```

Utility for changing output parameters in Jupyter notebooks ([IRKernel kernel](https://github.com/IRkernel/IRkernel)), not relevant if using RStudio or scripting R from terminal:


```R
set_size = function(w, h, factor=1.5) {
    s = 1 * factor
    options(
        repr.plot.width=w * s,
        repr.plot.height=h * s,
        repr.plot.res=100 / factor,
        jupyter.plot_mimetypes='image/png',
        jupyter.plot_scale=1
    )
}
```

## 0. Basic usage

There are two required arguments:

- the first argument is expected to be a dataframe with both group indicator variables and covariates,
- the second argument specifies a list with names of column which indicate the group membership.

Additional arguments can be provided, such as `name` (specifies `xlab()` for intersection matrix) or `width_ratio` (specifies how much space should be occupied by the set size panel). Other such arguments are discussed at length later in this document.


```R
set_size(8, 3)
upset(movies, genres, name='genre', width_ratio=0.1)
```


![ ](Examples_R_files/Examples_R_12_0.png)


### 0.1 Selecting intersections

We will focus on the intersections with at least ten members `(min_size=10)` and on a few variables which are significantly different between the intersections (see 2. Running statistical tests).

When using `min_size`, the empty groups will be skipped by default (e.g. *Short* movies would have no overlap with size of 10). To keep all groups pass `keep_empty_groups=TRUE`:


```R
set_size(8, 3)
(
    upset(movies, genres, name='genre', width_ratio=0.1, min_size=10, wrap=TRUE, set_sizes=FALSE)
    + ggtitle('Without empty groups (Short dropped)')
    +    # adding plots is possible thanks to patchwork
    upset(movies, genres, name='genre', width_ratio=0.1, min_size=10, keep_empty_groups=TRUE, wrap=TRUE, set_sizes=FALSE)
    + ggtitle('With empty groups')
)
```


![ ](Examples_R_files/Examples_R_15_0.png)


When empty columns are detected a warning will be issued. The silence it, pass `warn_when_dropping_groups=FALSE`. Complimentary `max_size` can be used in tandem.

You can also select intersections by degree (`min_degree` and `max_degree`):


```R
set_size(8, 3)
upset(
    movies, genres, width_ratio=0.1,
    min_degree=3,
)
```


![ ](Examples_R_files/Examples_R_18_0.png)


Or request a constant number of intersections with `n_intersections`:


```R
set_size(8, 3)
upset(
    movies, genres, width_ratio=0.1,
    n_intersections=15
)
```


![ ](Examples_R_files/Examples_R_20_0.png)


## 1. Adding components

We can add multiple annotation components (also called panels):


```R
set_size(8, 8)

set.seed(0)   # keep the same jitter for identical plots

upset(
    movies,
    genres,
    annotations = list(
        'Length'=list(
            aes=aes(x=intersection, y=length),
            geom=geom_boxplot()
        ),
        'Rating'=list(
            aes=aes(x=intersection, y=rating),
            geom=list(
                # checkout ggbeeswarm::geom_quasirandom for better results!
                geom_jitter(aes(color=log10(votes))),
                geom_violin(alpha=0.5)
            )
        ),
        'Budget'=list(
            aes=aes(x=intersection, y=budget),
            geom=geom_boxplot()
        )
    ),
    min_size=10,
    width_ratio=0.1
)
```


![ ](Examples_R_files/Examples_R_23_0.png)


For simple annotations, such as the length above, you can use a shorthand notation of `upset_annotate`:


```R
set_size(8, 6)

upset(
    movies,
    genres,
    annotations = list(
        'Length'=upset_annotate('length', geom_boxplot()),
        'Budget'=upset_annotate('budget', geom_boxplot())
    ),
    min_size=10,
    width_ratio=0.1
)
```


![ ](Examples_R_files/Examples_R_25_0.png)


You can also use barplots to demonstrate differences in proportions of categorical variables:


```R
set_size(8, 5)

upset(
    movies,
    genres,
    annotations = list(
        'MPAA Rating'=list(
            aes=aes(x=intersection, fill=mpaa),
            geom=list(
                geom_bar(stat='count', position='fill'),
                scale_y_continuous(labels=scales::percent_format()),
                scale_fill_manual(values=c(
                    'R'='#E41A1C', 'PG'='#377EB8',
                    'PG-13'='#4DAF4A', 'NC-17'='#FF7F00'
                ))
            )
        )
    ),
    width_ratio=0.1
)
```


![ ](Examples_R_files/Examples_R_27_0.png)


## 2. Running statistical tests


```R
upset_test(movies, genres)
```

    [1] "year, length, budget, rating, votes, r1, r2, r3, r4, r5, r6, r7, r8, r9, r10, mpaa differ significantly between intersections"



<table>
<caption>A data.frame: 17 × 5</caption>
<thead>
	<tr><th></th><th scope=col>variable</th><th scope=col>p.value</th><th scope=col>statistic</th><th scope=col>test</th><th scope=col>fdr</th></tr>
	<tr><th></th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
	<tr><th scope=row>length</th><td>length</td><td>6.511525e-71</td><td>422.88444</td><td>Kruskal-Wallis rank sum test</td><td>1.106959e-69</td></tr>
	<tr><th scope=row>rating</th><td>rating</td><td>1.209027e-46</td><td>301.72764</td><td>Kruskal-Wallis rank sum test</td><td>1.027673e-45</td></tr>
	<tr><th scope=row>budget</th><td>budget</td><td>3.899860e-44</td><td>288.97476</td><td>Kruskal-Wallis rank sum test</td><td>2.209921e-43</td></tr>
	<tr><th scope=row>r8</th><td>r8    </td><td>9.900004e-39</td><td>261.28815</td><td>Kruskal-Wallis rank sum test</td><td>4.207502e-38</td></tr>
	<tr><th scope=row>mpaa</th><td>mpaa  </td><td>3.732200e-35</td><td>242.77939</td><td>Kruskal-Wallis rank sum test</td><td>1.268948e-34</td></tr>
	<tr><th scope=row>r9</th><td>r9    </td><td>1.433256e-30</td><td>218.78160</td><td>Kruskal-Wallis rank sum test</td><td>4.060891e-30</td></tr>
	<tr><th scope=row>r1</th><td>r1    </td><td>2.211600e-23</td><td>180.32740</td><td>Kruskal-Wallis rank sum test</td><td>5.371029e-23</td></tr>
	<tr><th scope=row>r4</th><td>r4    </td><td>1.008119e-18</td><td>154.62772</td><td>Kruskal-Wallis rank sum test</td><td>2.142254e-18</td></tr>
	<tr><th scope=row>r3</th><td>r3    </td><td>2.568227e-17</td><td>146.70217</td><td>Kruskal-Wallis rank sum test</td><td>4.851095e-17</td></tr>
	<tr><th scope=row>r5</th><td>r5    </td><td>9.823827e-16</td><td>137.66310</td><td>Kruskal-Wallis rank sum test</td><td>1.670051e-15</td></tr>
	<tr><th scope=row>r7</th><td>r7    </td><td>9.201549e-14</td><td>126.19243</td><td>Kruskal-Wallis rank sum test</td><td>1.422058e-13</td></tr>
	<tr><th scope=row>r2</th><td>r2    </td><td>2.159955e-13</td><td>124.00604</td><td>Kruskal-Wallis rank sum test</td><td>3.059936e-13</td></tr>
	<tr><th scope=row>r10</th><td>r10   </td><td>1.283470e-11</td><td>113.38113</td><td>Kruskal-Wallis rank sum test</td><td>1.678384e-11</td></tr>
	<tr><th scope=row>votes</th><td>votes </td><td>2.209085e-10</td><td>105.79588</td><td>Kruskal-Wallis rank sum test</td><td>2.682460e-10</td></tr>
	<tr><th scope=row>r6</th><td>r6    </td><td>3.779129e-05</td><td> 70.80971</td><td>Kruskal-Wallis rank sum test</td><td>4.283013e-05</td></tr>
	<tr><th scope=row>year</th><td>year  </td><td>2.745818e-02</td><td> 46.55972</td><td>Kruskal-Wallis rank sum test</td><td>2.917431e-02</td></tr>
	<tr><th scope=row>title</th><td>title </td><td>2.600003e-01</td><td> 34.53375</td><td>Kruskal-Wallis rank sum test</td><td>2.600003e-01</td></tr>
</tbody>
</table>



`Kruskal-Wallis rank sum test` is not always the best choice.

You can either change the test for:

 - all the variables (`test=your.test`), or
 - specific variables (using `tests=list(variable=some.test)` argument)

The tests are called with `(formula=variable ~ intersection, data)` signature, such as accepted by `kruskal.test`. The result is expected to be a list with following members:

- `p.value`
- `statistic`
- `method`

It is easy to adapt tests which do not obey this signature/output convention; for example the Chi-squared test and anova can be wrapped with two-line functions as follows:


```R
chisq_from_formula = function(formula, data) {
    chisq.test(
        ftable(formula, data)
    )
}

anova_single = function(formula, data) {
    result = summary(aov(formula, data))
    list(
        p.value=result[[1]][['Pr(>F)']][[1]],
        method='Analysis of variance Pr(>F)',
        statistic=result[[1]][['F value']][[1]]
    )
}

custom_tests = list(
    mpaa=chisq_from_formula,
    budget=anova_single
)
```


```R
head(upset_test(movies, genres, tests=custom_tests))
```

    Warning message in chisq.test(ftable(formula, data)):
    “Chi-squared approximation may be incorrect”


    [1] "year, length, budget, rating, votes, r1, r2, r3, r4, r5, r6, r7, r8, r9, r10, mpaa differ significantly between intersections"



<table>
<caption>A data.frame: 6 × 5</caption>
<thead>
	<tr><th></th><th scope=col>variable</th><th scope=col>p.value</th><th scope=col>statistic</th><th scope=col>test</th><th scope=col>fdr</th></tr>
	<tr><th></th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
	<tr><th scope=row>length</th><td>length</td><td>6.511525e-71</td><td>422.88444</td><td>Kruskal-Wallis rank sum test</td><td>1.106959e-69</td></tr>
	<tr><th scope=row>budget</th><td>budget</td><td>1.348209e-60</td><td> 13.66395</td><td>Analysis of variance Pr(&gt;F) </td><td>1.145977e-59</td></tr>
	<tr><th scope=row>rating</th><td>rating</td><td>1.209027e-46</td><td>301.72764</td><td>Kruskal-Wallis rank sum test</td><td>6.851151e-46</td></tr>
	<tr><th scope=row>mpaa</th><td>mpaa  </td><td>9.799097e-42</td><td>406.33814</td><td>Pearson's Chi-squared test  </td><td>4.164616e-41</td></tr>
	<tr><th scope=row>r8</th><td>r8    </td><td>9.900004e-39</td><td>261.28815</td><td>Kruskal-Wallis rank sum test</td><td>3.366002e-38</td></tr>
	<tr><th scope=row>r9</th><td>r9    </td><td>1.433256e-30</td><td>218.78160</td><td>Kruskal-Wallis rank sum test</td><td>4.060891e-30</td></tr>
</tbody>
</table>



Many tests will require at least two observations in each group. You can skip intersections with less than two members with `min_size=2`.


```R
bartlett_results = suppressWarnings(upset_test(movies, genres, test=bartlett.test, min_size=2))
tail(bartlett_results)
```

    [1] "NA, year, length, budget, rating, votes, r1, r2, r3, r4, r5, r6, r7, r8, r9, r10, NA differ significantly between intersections"



<table>
<caption>A data.frame: 6 × 5</caption>
<thead>
	<tr><th></th><th scope=col>variable</th><th scope=col>p.value</th><th scope=col>statistic</th><th scope=col>test</th><th scope=col>fdr</th></tr>
	<tr><th></th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
	<tr><th scope=row>year</th><td>year  </td><td>1.041955e-67</td><td>386.53699</td><td>Bartlett test of homogeneity of variances</td><td>1.302444e-67</td></tr>
	<tr><th scope=row>length</th><td>length</td><td>3.982729e-67</td><td>383.70148</td><td>Bartlett test of homogeneity of variances</td><td>4.595457e-67</td></tr>
	<tr><th scope=row>budget</th><td>budget</td><td>7.637563e-50</td><td>298.89911</td><td>Bartlett test of homogeneity of variances</td><td>8.183103e-50</td></tr>
	<tr><th scope=row>rating</th><td>rating</td><td>3.980194e-06</td><td> 66.63277</td><td>Bartlett test of homogeneity of variances</td><td>3.980194e-06</td></tr>
	<tr><th scope=row>title</th><td>title </td><td>          NA</td><td>       NA</td><td>Bartlett test of homogeneity of variances</td><td>          NA</td></tr>
	<tr><th scope=row>mpaa</th><td>mpaa  </td><td>          NA</td><td>       NA</td><td>Bartlett test of homogeneity of variances</td><td>          NA</td></tr>
</tbody>
</table>



### 2.1 Ignore specific variables

You may want to exclude variables which are:

 - highly correlated and therefore interfering with the FDR calculation, or
 - simply irrelevant

In the movies example, the title variable is not a reasonable thing to compare. We can ignore it using:


```R
# note: title no longer present
rownames(upset_test(movies, genres, ignore=c('title')))
```

    [1] "year, length, budget, rating, votes, r1, r2, r3, r4, r5, r6, r7, r8, r9, r10, mpaa differ significantly between intersections"



<style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>'length'</li><li>'rating'</li><li>'budget'</li><li>'r8'</li><li>'mpaa'</li><li>'r9'</li><li>'r1'</li><li>'r4'</li><li>'r3'</li><li>'r5'</li><li>'r7'</li><li>'r2'</li><li>'r10'</li><li>'votes'</li><li>'r6'</li><li>'year'</li></ol>



## 3. Adjusting "Intersection size"

### 3.1 Counts

The counts over the bars can be disabled:


```R
set_size(8, 3)

upset(
    movies,
    genres,
    base_annotations=list(
        'Intersection size'=intersection_size(counts=FALSE)
    ),
    min_size=10,
    width_ratio=0.1
)
```


![ ](Examples_R_files/Examples_R_42_0.png)


The colors can be changed, and additional annotations added:


```R
set_size(8, 3)

upset(
    movies,
    genres,
    base_annotations=list(
        'Intersection size'=intersection_size(
            text_colors=c(
                on_background='brown', on_bar='yellow'
            )
        )
        + annotate(
            geom='text', x=Inf, y=Inf,
            label=paste('Total:', nrow(movies)),
            vjust=1, hjust=1
        )
        + ylab('Intersection size')
    ),
    min_size=10,
    width_ratio=0.1
)
```


![ ](Examples_R_files/Examples_R_44_0.png)


Any parameter supported by `geom_text` can be passed in `text` list:


```R
set_size(8, 3)

upset(
    movies,
    genres,
    base_annotations=list(
        'Intersection size'=intersection_size(
            text=list(
                vjust=-0.1,
                hjust=-0.1,
                angle=45
            )
        )
    ),
    min_size=10,
    width_ratio=0.1
)
```


![ ](Examples_R_files/Examples_R_46_0.png)


### 3.2 Fill the bars


```R
set_size(8, 3)

upset(
    movies,
    genres,
    base_annotations=list(
        'Intersection size'=intersection_size(
            counts=FALSE,
            aes=aes(fill=mpaa)
        )
    ),
    width_ratio=0.1
)
```


![ ](Examples_R_files/Examples_R_48_0.png)



```R
set_size(8, 3)
upset(
    movies,
    genres,
    base_annotations=list(
        'Intersection size'=intersection_size(
            counts=FALSE,
            aes=aes(fill=mpaa)
        ) + scale_fill_manual(values=c(
            'R'='#E41A1C', 'PG'='#377EB8',
            'PG-13'='#4DAF4A', 'NC-17'='#FF7F00'
        ))
    ),
    width_ratio=0.1
)
```


![ ](Examples_R_files/Examples_R_49_0.png)



```R
set_size(8, 3)

upset(
    movies,
    genres,
    base_annotations=list(
        'Intersection size'=intersection_size(
            counts=FALSE,
            aes=aes(fill='bars_color')
        ) + scale_fill_manual(values=c('bars_color'='blue'), guide='none')
    ),
    width_ratio=0.1
)
```


![ ](Examples_R_files/Examples_R_50_0.png)


### 3.3 Adjusting the height ratio

Setting `height_ratio=1` will cause the intersection matrix and the intersection size to have an equal height:


```R
set_size(8, 3)

upset(
    movies,
    genres,
    height_ratio=1,
    width_ratio=0.1
)
```


![ ](Examples_R_files/Examples_R_53_0.png)


### 3.5 Hiding intersection size

You can always disable the intersection size altogether:


```R
set_size(8, 1.6)
upset(
    movies,
    genres,
    base_annotations=list(),
    min_size=10,
    width_ratio=0.1
)
```


![ ](Examples_R_files/Examples_R_56_0.png)


### 3.6 Showing intersection size/union size ratio

It can be useful to visualise which intersections are larger than expected by chance (assuming equal probability of belonging to multiple sets); this can be achieved using the intersection size/union size ratio.

> Note: this ratio cannot be computed for the null intersection (observations which do not belong to either of the groups), as denominator would be 0.

> Important note: with early min/max trimming the intersection ratio uses the trimmed denominator. In most cases you probably want to set `min_max_early=FALSE` when plotting ratios with any kind of filtering imposed.


```R
set_size(8, 6)
upset(
    movies, genres, name='genre', width_ratio=0.1, min_size=10,
    base_annotations=list(
        'Intersection size'=intersection_size(),
        'Intersection ratio'=intersection_ratio()
    ),
    min_max_early=FALSE
)
```

    Warning message:
    “Removed 62 rows containing missing values (position_stack).”



![ ](Examples_R_files/Examples_R_59_1.png)


The plot above tells us that the analysed documentary movies are almost always (in over 60% of cases) documentaries (and nothing more!), while comedies more often include elements of other genres (e.g. drama, romance) rather than being comedies alone (like stand-up shows).

### 3.7 Showing percentages

`text_aes` can be used to manipulate the aesthetics of the labels. Using the `intersection_size` and `union_size` one can calculate percentage of items in the intersection (relative to the potential size of the intersection). A `upset_text_percentage(digits=0, sep='')` shorthand is provided for convenience; please note that it has to be used with `aes_` rather than `aes`:


```R
set_size(8, 6)
upset(
    movies, genres, name='genre', width_ratio=0.1, min_size=10,
    base_annotations=list(
        # with manual aes specification:
        'Intersection size'=intersection_size(text_aes=aes(label=paste0(round(intersection_size/union_size * 100), '%'))),
        # using shorthand:
        'Intersection ratio'=intersection_ratio(text_aes=aes_(label=upset_text_percentage()))
    ),
    min_max_early=FALSE
)
```

    Warning message:
    “Removed 62 rows containing missing values (position_stack).”



![ ](Examples_R_files/Examples_R_63_1.png)


Also see [10. Display percentages](#10-display-percentages).

### 3.8 Further adjustments using ggplot2 functions


```R
set_size(8, 3)
upset(
    movies, genres, width_ratio=0.1,
    base_annotations = list(
        'Intersection size'=(
            intersection_size()
            + ylim(c(0, 700))
            + theme(plot.background=element_rect(fill='#E5D3B3'))
            + ylab('# observations in intersection')
        )
    ),
    min_size=10
)
```


![ ](Examples_R_files/Examples_R_66_0.png)


## 4. Adjusting "set size"

### 4.1 Rotate labels

To rotate the labels modify corresponding theme:


```R
set_size(4, 3)
upset(
    movies, genres,
    min_size=100,
    width_ratio=0.15,
    set_sizes=(
        upset_set_size(width=0.6)
        + theme(axis.text.x=element_text(angle=90))
    )
)
```


![ ](Examples_R_files/Examples_R_70_0.png)


To display the ticks:


```R
set_size(4, 3)
upset(
    movies, genres, width_ratio=0.3, min_size=100, wrap=TRUE,
    set_sizes=(
        upset_set_size(width=0.6)
        + theme(axis.ticks.x=element_line())
    )
)
```


![ ](Examples_R_files/Examples_R_72_0.png)


### 4.2 Modify geoms and other layers

Arguments of the `geom_bar` can be passed to `upset_set_size`; it can even use a different geom, or be replaced with a custom list of layers altogether:


```R
set_size(8, 3)

(
    upset(
        movies, genres, width_ratio=0.5, max_size=100, min_size=15, wrap=TRUE,
        set_sizes=upset_set_size(
            width=0.4
        )
    )
    +
    upset(
        movies, genres, width_ratio=0.5, max_size=100, min_size=15, wrap=TRUE,
        set_sizes=upset_set_size(
            geom=geom_point,
            stat='count',
            color='blue'
        )
    )
    +
    upset(
        movies, genres, width_ratio=0.5, max_size=100, min_size=15, wrap=TRUE,
        set_sizes=(
            upset_set_size(
                geom=geom_point,
                mapping=aes(y=..count../max(..count..)),
                stat='count'
            )
            + ylab('Size relative to the largest')
        )
    )
)
```


![ ](Examples_R_files/Examples_R_75_0.png)


### 4.3 Logarithmic scale

In order to use a log scale we need pass additional scale to in `layers` argument. However, as the bars are on flipped coordinates, we need a reversed log transformation. Appropriate function, `reverse_log_trans()` is provided:


```R
set_size(5, 3)

upset(
    movies, genres,
    width_ratio=0.1,
    min_size=10,
    set_sizes=(
        upset_set_size(width=0.4)
        + theme(axis.text.x=element_text(angle=90))
        + scale_y_continuous(trans=reverse_log_trans())
    ),
    queries=list(upset_query(set='Drama', fill='blue'))
)
```


![ ](Examples_R_files/Examples_R_78_0.png)


We can also modify the labels to display the logged values:


```R
set_size(5, 3)

upset(
    movies, genres,
    min_size=10,
    width_ratio=0.2,
    set_sizes=upset_set_size(width=0.4)
        + scale_y_continuous(
            trans=reverse_log_trans(),
            labels=log10
        )
        + ylab('log10(set size)')
)
```


![ ](Examples_R_files/Examples_R_80_0.png)


Or display the actual count:


```R
set_size(5, 3)

upset(
    movies, genres,
    min_size=10,
    width_ratio=0.3,
    set_sizes=(
        upset_set_size(
            width=0.4,
            geom=function(...) {
                list(
                    geom_bar(...),
                    geom_text(..., aes(label=..count..), hjust=1.1)
                )
            },
            stat='count'
        )
        + expand_limits(y=1100)
        + theme(axis.text.x=element_text(angle=90))
    )
)
```


![ ](Examples_R_files/Examples_R_82_0.png)


### 4.4 Hide the set sizes altogether


```R
set_size(5, 3)

upset(
    movies, genres,
    min_size=10,
    set_sizes=FALSE
)
```


![ ](Examples_R_files/Examples_R_84_0.png)


## 5. Adjusting other aesthetics

### 5.1 Stripes

Change the colors:


```R
set_size(6, 4)
upset(
    movies,
    genres,
    min_size=10,
    width_ratio=0.2,
    stripes=c('cornsilk1', 'deepskyblue1')
)
```


![ ](Examples_R_files/Examples_R_88_0.png)


You can use multiple colors:


```R
set_size(6, 4)
upset(
    movies,
    genres,
    min_size=10,
    width_ratio=0.2,
    stripes=c('cornsilk1', 'deepskyblue1', 'grey90')
)
```


![ ](Examples_R_files/Examples_R_90_0.png)


Or, set the color to white to effectively disable the stripes:


```R
set_size(6, 4)
upset(
    movies,
    genres,
    min_size=10,
    width_ratio=0.2,
    stripes='white'
)
```


![ ](Examples_R_files/Examples_R_92_0.png)


### 5.2 Adding title

Adding title with `ggtitle` with add it to the intersection matrix:


```R
set_size(6, 4)
upset(movies, genres, min_size=10) + ggtitle('Intersection matrix title')
```


![ ](Examples_R_files/Examples_R_95_0.png)


In order to add a title for the entire plot, you need to wrap the plot:


```R
set_size(6, 4)
upset(movies, genres, min_size=10, wrap=TRUE) + ggtitle('The overlap between genres')
```


![ ](Examples_R_files/Examples_R_97_0.png)


### 5.3 Making the plot transparent

You need to set the plot background to transparent and adjust colors of stripes to your liking:


```R
set_size(6, 4)
(
    upset(
        movies, genres, name='genre', width_ratio=0.1, min_size=10,
        stripes=c(alpha('grey90', 0.45), alpha('white', 0.3))
    )
    & theme(plot.background=element_rect(fill='transparent', color=NA))
)
```


![ ](Examples_R_files/Examples_R_100_0.png)


Use `ggsave('upset.png', bg="transparent")` when exporting to PNG.

## 6. Themes

The themes for specific components are defined in `upset_themes` list, which contains themes for:


```R
names(upset_themes)
```


<style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>'intersections_matrix'</li><li>'Intersection size'</li><li>'overall_sizes'</li><li>'default'</li></ol>



You can substitute this list for your own using `themes` argument. While you can specify a theme for every component, if you omit one or more components those will be taken from the element named `default`.

### 6.1 Substituting themes


```R
set_size(8, 4)
upset(movies, genres, min_size=10, themes=list(default=theme()))
```


![ ](Examples_R_files/Examples_R_107_0.png)


You can also add themes for your custom panels/annotations:


```R
set_size(8, 8)

upset(
    movies,
    genres,
    annotations = list(
        'Length'=list(
            aes=aes(x=intersection, y=length),
            geom=geom_boxplot()
        ),
        'Rating'=list(
            aes=aes(x=intersection, y=rating),
            geom=list(
                geom_jitter(aes(color=log10(votes))),
                geom_violin(alpha=0.5)
            )
        )
    ),
    min_size=10,
    width_ratio=0.1,
    themes=modifyList(
        upset_themes,
        list(Rating=theme_void(), Length=theme())
    )
)
```


![ ](Examples_R_files/Examples_R_109_0.png)


### 6.2 Adjusting the default themes

Modify all the default themes as once with `upset_default_themes()`:


```R
set_size(8, 4)

upset(
    movies, genres, min_size=10, width_ratio=0.1,
    themes=upset_default_themes(text=element_text(color='red'))
)
```


![ ](Examples_R_files/Examples_R_112_0.png)


To modify only a subset of default themes use `upset_modify_themes()`:


```R
set_size(8, 4)

upset(
    movies, genres,
    base_annotations=list('Intersection size'=intersection_size(counts=FALSE)),
    min_size=100,
    width_ratio=0.1,
    themes=upset_modify_themes(
        list(
            'intersections_matrix'=theme(text=element_text(size=20)),
            'overall_sizes'=theme(axis.text.x=element_text(angle=90))
        )
    )
)
```


![ ](Examples_R_files/Examples_R_114_0.png)


## 7. Highlighting (queries)

Pass a list of lists generated with `upset_query()` utility to the optional `queries` argument to selectively modify aesthetics of specific intersections or sets.

Use one of the arguments: `set` or `intersection` (not both) to specify what to highlight:
- `set` will highlight the bar of the set size,
- `intersection` will highlight an intersection on all components (by default), or on components chosen with `only_components`
- all other parameters will be used to modify the geoms


```R
set_size(8, 6)

upset(
    movies, genres, name='genre', width_ratio=0.1, min_size=10,
    annotations = list(
        'Length'=list(
            aes=aes(x=intersection, y=length),
            geom=geom_boxplot()
        )
    ),
    queries=list(
        upset_query(
            intersect=c('Drama', 'Comedy'),
            color='red',
            fill='red',
            only_components=c('intersections_matrix', 'Intersection size')
        ),
        upset_query(
            set='Drama',
            fill='blue'
        ),
        upset_query(
            intersect=c('Romance', 'Comedy'),
            fill='yellow',
            only_components=c('Length')
        )
    )
)
```


![ ](Examples_R_files/Examples_R_117_0.png)


## 8. Sorting

### 8.1 Sorting intersections

By degree:


```R
set_size(8, 3)
upset(movies, genres, width_ratio=0.1, sort_intersections_by='degree')
```


![ ](Examples_R_files/Examples_R_121_0.png)


By ratio:


```R
set_size(8, 4)
upset(
    movies, genres, name='genre', width_ratio=0.1, min_size=10,
    sort_intersections_by='ratio',
    base_annotations=list(
        'Intersection size'=intersection_size(text_aes=aes_(label=upset_text_percentage())),
        'Intersection ratio'=intersection_ratio(text_aes=aes_(label=upset_text_percentage()))
    )
)
```


![ ](Examples_R_files/Examples_R_123_0.png)


The other way around:


```R
set_size(8, 3)
upset(movies, genres, width_ratio=0.1, sort_intersections='ascending')
```


![ ](Examples_R_files/Examples_R_125_0.png)


Without any sorting:


```R
set_size(8, 3)
upset(movies, genres, width_ratio=0.1, sort_intersections=FALSE)
```


![ ](Examples_R_files/Examples_R_127_0.png)


### 8.2 Sorting sets

Ascending:


```R
set_size(8, 3)
upset(movies, genres, width_ratio=0.1, sort_sets='ascending')
```


![ ](Examples_R_files/Examples_R_130_0.png)


Without sorting - preserving the order as in genres:


```R
genres
```


<style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>'Action'</li><li>'Animation'</li><li>'Comedy'</li><li>'Drama'</li><li>'Documentary'</li><li>'Romance'</li><li>'Short'</li></ol>




```R
set_size(8, 3)
upset(movies, genres, width_ratio=0.1, sort_sets=FALSE)
```


![ ](Examples_R_files/Examples_R_133_0.png)


## 9. Grouping

### 9.1 Grouping intersections

Use `group_by='sets'` to group intersections by set. If needed, the intersections will be repeated so that they appear in each set group. Use `upset_query()` with `group` argument to color the intersection matrix accordingly.


```R
set_size(8, 3)

upset(
    movies, c("Action", "Comedy", "Drama"),
    width_ratio=0.2,
    group_by='sets',
    queries=list(
        upset_query(
            intersect=c('Drama', 'Comedy'),
            color='red',
            fill='red',
            only_components=c('intersections_matrix', 'Intersection size')
        ),
        upset_query(group='Drama', color='blue'),
        upset_query(group='Comedy', color='orange'),
        upset_query(group='Action', color='purple'),
        upset_query(set='Drama', fill='blue'),
        upset_query(set='Comedy', fill='orange'),
        upset_query(set='Action', fill='purple')
    )
)
```


![ ](Examples_R_files/Examples_R_137_0.png)


## 10. Display percentages

Use `aes_percentage()` utility preceded with `!!` syntax to easily display percentages. In the examples below only percentages for the movies with R rating are shown to avoid visual clutter.


```R
rating_scale = scale_fill_manual(values=c(
    'R'='#E41A1C', 'PG'='#377EB8',
    'PG-13'='#4DAF4A', 'NC-17'='#FF7F00'
))
show_hide_scale = scale_color_manual(values=c('show'='black', 'hide'='transparent'), guide=FALSE)
```

### 10.1 Within intersection


```R
set_size(8, 5)

upset(
    movies, genres, name='genre', width_ratio=0.1, min_size=100,
    annotations =list(
        'MPAA Rating'=list(
            aes=aes(x=intersection, fill=mpaa),
            geom=list(
                geom_bar(stat='count', position='fill'),
                geom_text(
                    aes(
                        label=!!aes_percentage(relative_to='intersection'),
                        color=ifelse(mpaa == 'R', 'show', 'hide')
                    ),
                    stat='count',
                    position=position_fill(vjust = .5)
                ),
                scale_y_continuous(labels=scales::percent_format()),
                show_hide_scale,
                rating_scale
            )
        )
    )
)
```


![ ](Examples_R_files/Examples_R_142_0.png)


### 10.2 Relative to the group


```R
set_size(8, 5)

upset(
    movies, genres, name='genre', width_ratio=0.1, min_size=100,
    annotations =list(
        'MPAA Rating'=list(
            aes=aes(x=intersection, fill=mpaa),
            geom=list(
                geom_bar(stat='count', position='fill'),
                geom_text(
                    aes(
                        label=!!aes_percentage(relative_to='group'),
                        group=mpaa,
                        color=ifelse(mpaa == 'R', 'show', 'hide')
                    ),
                    stat='count',
                    position=position_fill(vjust = .5)
                ),
                scale_y_continuous(labels=scales::percent_format()),
                show_hide_scale,
                rating_scale
            )
        )
    )
)

```


![ ](Examples_R_files/Examples_R_144_0.png)


### 10.3 Relative to all observed values


```R
set_size(8, 5)

upset(
    movies, genres, name='genre', width_ratio=0.1, min_size=100,
    annotations =list(
        'MPAA Rating'=list(
            aes=aes(x=intersection, fill=mpaa),
            geom=list(
                geom_bar(stat='count', position='fill'),
                geom_text(
                    aes(
                        label=!!aes_percentage(relative_to='all'),
                        color=ifelse(mpaa == 'R', 'show', 'hide')
                    ),
                    stat='count',
                    position=position_fill(vjust = .5)
                ),
                scale_y_continuous(labels=scales::percent_format()),
                show_hide_scale,
                rating_scale
            )
        )
    )
)
```


![ ](Examples_R_files/Examples_R_146_0.png)


## 11. Advanced usage examples

### 11.1 Display text on some bars only


```R
set_size(8, 5)

upset(
    movies, genres, name='genre', width_ratio=0.1, min_size=100,
    annotations =list(
        'MPAA Rating'=list(
            aes=aes(x=intersection, fill=mpaa),
            geom=list(
                geom_bar(stat='count', position='fill'),
                geom_text(
                    aes(label=ifelse(mpaa == 'R', 'R', NA)),
                    stat='count',
                    position=position_fill(vjust = .5),
                    na.rm=TRUE
                ),
                show_hide_scale,
                rating_scale
            )
        )
    )
)
```


![ ](Examples_R_files/Examples_R_149_0.png)


### 11.2 Combine multiple plots together


```R
set_size(8, 5)
library(patchwork)

annotations = list(
    'MPAA Rating'=list(
        aes=aes(x=intersection, fill=mpaa),
        geom=list(
            geom_bar(stat='count', position='fill')
        )
    )
)
set.seed(0)    # for replicable example only

data_1 = movies[sample(nrow(movies), 100), ]
data_2 = movies[sample(nrow(movies), 100), ]

u1 = upset(data_1, genres, min_size=5, base_annotations=annotations)
u2 = upset(data_2, genres, min_size=5, base_annotations=annotations)

(u1 | u2) + plot_layout(guides='collect')
```


![ ](Examples_R_files/Examples_R_151_0.png)


### 11.3 Change height of the annotations


```R
set_size(8, 3.5)
upset(
    movies, genres, name='genre', width_ratio=0.1, min_size=100,
    annotations =list(
        'MPAA Rating'=list(
            aes=aes(x=intersection, fill=mpaa),
            geom=list(
                geom_bar(stat='count', position='fill'),
                scale_y_continuous(labels=scales::percent_format())
            )
        )
    )
) + patchwork::plot_layout(heights=c(0.5, 1, 0.5))
```


![ ](Examples_R_files/Examples_R_153_0.png)

